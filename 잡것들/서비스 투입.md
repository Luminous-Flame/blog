(adtg, antg, altg, gd-bid, hd-bid, rtb-dk-web)

서비스 배포 및 제외 시 sysoper 공지

- ### **서비스 배포**
    
    - #### mint에서 배포
        
        1. make-leather-new에서 basic_set.yml 배포(mint)  
              
            
        2. ade.yml 배포(mint)  
              
            
        3. crontab 확인(/srv/widerplanet/bin/log_post_proc.sh 등)  
              
            
        4. /srv/widerplanet/bin/log_post_proc.sh 파일 유무 확인  
              
            
        5. rsyncd.conf 확인  
              
            
    - #### wasible에서 배포
        
        1. flume-agent.service 서비스 확인
            - /opt/apache-flume/logs/flume.krAdeLog.log 확인(ade-java.yml 배포 후 로그 확인)
                - flume prometheus 모니터링 리스트 확인 및 추가
                    - hd-chanel-edge-13에서 /data/cluster/prometheus/config/target.json에서 제외
                    - bdp팀 소라님에게 flume prometheus 모니터링에서 제외 되었다고 알리고 아카이빙 확인
                        
        2. history 참조 해서 버전 확인 및 실제 동작중인 서비스 버전 확인(cat /etc/systemd/system/ade.service | grep Description)  
              
            
        3. history 참조하여 해당 버전으로 ade-java.yml 배포(wasible)
            - 8080 java, 80 nginx 포트 확인
            - /var/log/wpweb/kr/access/ pass, bid 등 파일 확인
            - log_post_proc.sh 동작 확인 (/var/log/wpweb/kr/archive)
            - 아카이빙 파일을 로그 워커가 가져가서 하둡에 잘 적재되어있는지 확인
                
                |   |
                |---|
                |`[root@hd-chanel-edge-15 ~]# hdfs dfs -ls /user/weblog/kr/pass/20230703/14 \| egrep` `'gd-bid-01'`<br><br>`-rw-r--r--   1 sysoper sysoper   86344808 2023-07-03 14:09 /user/weblog/kr/pass/20230703/14/pass.gd-bid-01.202307031400.gz`<br><br>`-rw-r--r--   1 sysoper sysoper   85882069 2023-07-03 14:10 /user/weblog/kr/pass/20230703/14/pass.gd-bid-01.202307031401.gz`<br><br>`-rw-r--r--   1 sysoper sysoper   82672068 2023-07-03 14:11 /user/weblog/kr/pass/20230703/14/pass.gd-bid-01.202307031402.gz`|
                
- ## 서비스 포트
    
    - rsync: 873
    - flume: 8080 제외한 포트 4개 (랜덤일거임. flume PID 를 통해 포트 4개 떳는지 확인)
        
        |   |
        |---|
        |`sysoper@astg-41:~$ sudo netstat -tnlp\|grep java`<br><br>`tcp6       0      0 :::8217                 :::*                    LISTEN      2796873/java`<br><br>`tcp6       0      0 :::3067                 :::*                    LISTEN      2796873/java`<br><br>`tcp6       0      0 :::7521                 :::*                    LISTEN      2796873/java`<br><br>`tcp6       0      0 :::4067                 :::*                    LISTEN      2796873/java`<br><br>`tcp6       0      0 :::8080                 :::*                    LISTEN      663686/java`|
        
    - nginx: 80 (astg 는  90 도 떠야 한다)
    - ade: 8080  
        - astg 경우 php-fpm 확인
            
            |   |
            |---|
            |`root@astg-41:/etc/nginx/sites-enabled# cat astg.widerplanet.com.conf`<br><br>`# Ansible managed`<br><br>`server {`<br><br>    `listen       80;`<br><br>`...`<br><br>    `location / {`<br><br>`...`<br><br>        `fastcgi_pass            unix:/run/php7.3-fpm.sock;`<br><br>`...`<br><br>`root@astg-41:/etc/nginx/sites-enabled# ps aux\|grep php`<br><br>`root      662908  0.9  0.0 263056 27368 ?        Ss   15:07   2:02 php-fpm: master process (/etc/php/7.3/fpm/php-fpm.conf)`<br><br>`www-data  881230  1.6  0.0 896128 32776 ?        Sl   17:58   0:43 php-fpm: pool www`<br><br>`...`|
            
- ### **서비스 제외**
    
    - #### slb, rlb에서 /var/www/html/index.php 200 OK가 아니면 서비스에서 제외
        
        - 잠시 서비스 제외 시 index.php 변경
    - #### 디스크 교체 시
        
        1. index.php 변경  
              
            
        2. /var/log/wpweb/kr/access 로그 확인  
              
            
        3. netstat -natp | grep ESTA | wc -l ESTABLISHED 감소 확인  
              
            
        4. /opt/apache-flume/logs/flume.krAdeLog.log 확인(마지막 access 로그가 있는지)
            - flume prometheus 모니터링에서 not-flume으로 알람이 설정 되어 있어 모니터링 제외
                - hd-chanel-edge-13에서 /data/cluster/prometheus/config/target.json에서 제외
                - bdp팀 소라님에게 flume prometheus 모니터링에서 제외 되었다고 알리고 아카이빙 확인  
                      
                    
        5. 아카이빙 파일을 로그 워커가 가져가서 하둡에 잘 적재되어있는지 확인
            
            |   |
            |---|
            |`[root@hd-chanel-edge-15 ~]# hdfs dfs -ls /user/weblog/kr/pass/20230703/14 \| egrep` `'gd-bid-01'`<br><br>`-rw-r--r--   1 sysoper sysoper   86344808 2023-07-03 14:09 /user/weblog/kr/pass/20230703/14/pass.gd-bid-01.202307031400.gz`<br><br>`-rw-r--r--   1 sysoper sysoper   85882069 2023-07-03 14:10 /user/weblog/kr/pass/20230703/14/pass.gd-bid-01.202307031401.gz`<br><br>`-rw-r--r--   1 sysoper sysoper   82672068 2023-07-03 14:11 /user/weblog/kr/pass/20230703/14/pass.gd-bid-01.202307031402.gz`|
            
        6. wasible에서 배포하여 서비스에 투입될 것을 우려하여 hosts, dns에서 제외