
![[Pasted image 20240412025108.png]]
![[Pasted image 20240412025132.png]]

### h2load 명령어 설정:

```
h2load -c300 -n400000 -t8 -m400 http://10.3.5.50:80/ --rate=300
```
1. **`-c 300`**:
    - **클라이언트 수**: 300개의 클라이언트가 동시에 연결을 시도
2. **`-n 400000`**:
    - **요청 수**: 총 400,000개의 HTTP 요청을 전송
3. **`-t 8`**:
    - **쓰레드 수**: 부하 테스트를 수행할 쓰레드 수는 8개
4. **`-m 400`**:
    - **최대 동시 스트림**: 각 연결당 최대 400개의 동시 HTTP/2 스트림을 사용
5. **`--rate 300`**:
    - **연결 비율**: 초당 300개의 새로운 연결을 생성

### HAProxy 설정:
```
frontend    webserver
    bind    *:80
    mode    http
    maxconn 310
    timeout    client 2m
    option    forwardfor
    option    httplog
    default_backend ade

    acl too_many_connections fe_conn(webserver) gt 300
    use_backend pbcoffee if too_many_connections
    default_backend ade
```
- **`maxconn 310`**: 최대 310개의 동시 연결을 허용
	- 해당 설정을 지우고 같은 부하를 주었을 때, 

### 동작 결과:

1. **연결 처리**:
    - `h2load`가 생성하는 최대 동시 클라이언트 수 (300개)는 HAProxy의 `maxconn` (310개) 설정 범위 내에 있다. 이는 모든 클라이언트가 거의 즉시 서버에 연결되며 연결 거부 없이 요청을 처리할 수 있음을 의미.
2. **백엔드 라우팅**:
    - `fe_conn(webserver) gt 300`이라는 조건은 이 경우에 만족되지 않는다. (`fe_conn`은 300 이하이므로). 따라서 모든 요청은 기본 백엔드 `ade`로 라우팅되며, `pbcoffee` 백엔드는 사용되지 않는다.
3. **부하 유지**:
    - 초당 300개의 새로운 연결이 형성되고, 각 연결에서 최대 400개의 동시 스트림이 활성화될 수 있다. 이는 HAProxy와 서버가 고르게 부하를 받으며, 설정된 리밋 내에서 서비스 제공이 가능.
### 결론:

이 설정은 HAProxy의 동시 연결 최대 수치를 초과하지 않기 때문에, 설정된 백엔드(`ade`)를 통해 모든 요청이 처리 되었음. 네트워크 에러나 연결 실패 없이 효율적으로 부하가 관리 됨. 









![[Pasted image 20240412030311.png]]
![[Pasted image 20240412030331.png]]





![[Pasted image 20240412030543.png]]
![[Pasted image 20240412030528.png]]


### 주요 포인트 분석

1. **`fe_conn(webserver) gt 300`**:
    
    - `fe_conn(webserver)`는 프론트엔드 `webserver`에 현재 연결된 세션 수를 계산합니다.
    - 조건 `gt 300`은 세션 수가 300을 초과하는 경우 참이 됩니다.
    - **중요**: 초당 300개의 새로운 연결이 시도되지만, 이는 연결 속도(rate)이며, 서버에 동시에 유지되는 총 연결 수(`fe_conn`)와는 다릅니다. `fe_conn`의 값은 연결이 해제되지 않는 한 계속 증가할 수 있습니다.
2. **연결 및 세션 관리**:
    
    - `-c 310`은 동시에 310개의 연결을 열 수 있음을 의미합니다.
    - 연결이 빠르게 성립되고 해제되지 않는다면 (예: 서버 응답 지연), `fe_conn(webserver)`는 빠르게 300을 초과할 수 있습니다.
    - 일단 300을 초과하면, 그 이후 모든 새로운 연결과 현재 연결의 후속 요청들은 `pbcoffee`로 라우팅됩니다.
3. **서버 응답과 세션 해제**:
    
    - 서버가 요청을 빠르게 처리하고 연결을 닫지 않으면 (Keep-Alive 등), 연결 수가 높게 유지될 수 있습니다.
    - 이는 `pbcoffee`로 라우팅되는 요청 수를 증가시킵니다.

### 왜 `pbcoffee`로 많은 요청이 가는가?

- **세션 유지**:
    
    - 이 경우, HAProxy가 `webserver` 프론트엔드의 연결 수가 300을 초과하는 것을 감지하고, 추가 연결을 `pbcoffee`로 전환하는 것으로 보입니다. 이는 설정된 `acl`에 따른 자연스러운 동작입니다.
- **높은 연결 지속성**:
    
    - 만약 `h2load` 테스트가 연결을 빠르게 해제하지 않고 유지한다면 (클라이언트의 높은 동시 연결 요청), `fe_conn` 값이 쉽게 300을 초과할 수 있습니다. 특히 `-m 400` 설정은 많은 수의 HTTP/2 스트림이 하나의 TCP 연결에서 처리될 수 있도록 하여, 물리적인 TCP 연결 수보다 더 많은 요청을 가능하게 합니다.

### 결론

- `pbcoffee`로 많은 요청이 라우팅되는 현상은 `fe_conn(webserver)` 값이 설정된 임계값 300을 지속적으로 초과하기 때문입니다. 이는 연결이 짧은 시간 내에 많이 생성되고, 서버 또는 클라이언트 설정에 의해 빠르게 해제되지 않는 경우에 발생할 수 있습니다.

이러한 문제를 해결하기 위해선, HAProxy 로그를 확인하여 연결 패턴을 분석하고, 필요하다면 `timeout http-request`, `timeout http-keep-alive`, 또는 `timeout client` 설정을 조정하여 연결이 더 빠르게 종료되도록 유도할 수 있습니다. 이는 `pbcoffee`로의 요청 수를 줄이고 더 균형잡힌 로드 밸런싱을 달성하는데 도움이 될 것입니다.